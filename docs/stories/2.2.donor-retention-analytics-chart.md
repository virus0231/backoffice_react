# Story 2.2: Donor Retention Analytics Chart

## Status
Draft

## Story

**As a** development officer,
**I want** donor retention tracking in the Retention section of the sidebar dashboard showing repeat donor patterns over time,
**so that** I can identify retention trends and optimize donor stewardship strategies within the comprehensive analytics interface.

## Acceptance Criteria

1. Recharts line chart showing donor retention rates by time period
2. Retention calculation logic (repeat donors / total unique donors from previous period)
3. Comparison overlay functionality with percentage change calculations
4. Data table showing retention metrics, new donors, and repeat donor counts
5. Filter integration supporting appeals and date range analysis
6. Tooltip displaying retention percentage and donor counts
7. Chart styling matching FundraisUP aesthetic with appropriate color coding

## Tasks / Subtasks

- [ ] Create DonorRetentionChart component (AC: 1)
  - [ ] Build DonorRetentionChart component in `apps/web/components/charts/DonorRetentionChart.tsx`
  - [ ] Implement Recharts LineChart with retention rate time-series data
  - [ ] Configure chart with percentage-based Y-axis (0-100%) for retention rates
  - [ ] Add proper time period X-axis formatting (monthly/quarterly periods)
  - [ ] Style chart with retention-appropriate color scheme (green for high retention)
  - [ ] Create chart loading skeleton and error state components
- [ ] Implement donor retention calculation logic (AC: 2)
  - [ ] Create retention calculation utilities in `apps/web/lib/calculations/donorRetentionCalculations.ts`
  - [ ] Implement repeat donor identification logic across time periods
  - [ ] Calculate retention rate: (repeat donors in period / total donors from previous period) * 100
  - [ ] Handle edge cases: first period (no previous donors), zero donors in previous period
  - [ ] Create cohort-based retention tracking for more accurate calculations
  - [ ] Add validation for retention calculation accuracy and data integrity
- [ ] Add comparison overlay functionality (AC: 3)
  - [ ] Integrate comparison system from Story 1.4 with retention chart
  - [ ] Implement dual-line chart showing current vs. comparison period retention
  - [ ] Calculate percentage point changes in retention rates between periods
  - [ ] Add visual indicators for retention improvement/decline (green/red)
  - [ ] Create comparison legend with clear period identification
  - [ ] Include retention rate delta display in chart header
- [ ] Build donor retention data table (AC: 4)
  - [ ] Create DonorRetentionTable component in `apps/web/components/tables/DonorRetentionTable.tsx`
  - [ ] Implement columns: Period, Total Donors, New Donors, Repeat Donors, Retention Rate
  - [ ] Add sortable functionality for all numerical columns
  - [ ] Include comparison period data when overlay is active
  - [ ] Add donor segment breakdown (first-time, repeat, lapsed, reactivated)
  - [ ] Style table with retention rate color coding and visual indicators
- [ ] Integrate universal filter system (AC: 5)
  - [ ] Connect chart to global filter state for date range filtering
  - [ ] Implement appeals/campaigns filtering affecting retention calculations
  - [ ] Add funds filtering to analyze fund-specific donor retention
  - [ ] Support frequency filtering for retention analysis (exclude recurring vs. include all)
  - [ ] Ensure retention calculations respect filter boundaries
  - [ ] Add real-time chart updates when filter selections change
- [ ] Create interactive tooltips and hover states (AC: 6)
  - [ ] Build custom Recharts tooltip for retention rate display
  - [ ] Show retention percentage with proper formatting (e.g., "65.2%")
  - [ ] Include absolute donor counts: new donors, repeat donors, total donors
  - [ ] Add period identification in tooltip with readable date formatting
  - [ ] Include comparison data in tooltip when overlay is active
  - [ ] Style tooltips matching FundraisUP design specifications
- [ ] Implement appropriate chart styling and color coding (AC: 7)
  - [ ] Apply retention-specific color scheme: green for good retention, amber for declining
  - [ ] Add retention rate threshold indicators (e.g., >60% good, 40-60% moderate, <40% concerning)
  - [ ] Implement gradient background areas showing retention quality zones
  - [ ] Style chart matching FundraisUP aesthetic with professional appearance
  - [ ] Add retention benchmark lines or reference indicators
  - [ ] Ensure accessibility compliance with color contrast requirements

## Dev Notes

### Previous Story Insights
**Story Dependencies:** This story builds on the database foundation (Story 1.2), universal filter system (Story 1.3), comparison system (Story 1.4), and follows the operational analytics pattern established in Story 2.1.

### Technical Architecture Context
**Donor Retention Requirements:** [Source: docs/prd.md#functional-requirements]
- Donor Retention analytics with time-series visualization showing repeat donor patterns and retention rates (FR11)
- Integration with universal filter system for appeals and date range analysis
- Comparison overlay functionality showing retention trend changes
- Professional chart styling matching FundraisUP aesthetic

**Operational Analytics Context:** [Source: docs/prd.md#epic-2-operational-analytics-charts]
- Essential operational analytics providing operational insights for daily fundraising management
- Donor retention tracking for identifying retention trends and optimizing stewardship strategies
- Part of core MVP delivering immediate operational value

### Database Query Logic Context
**Donor Retention Query Structure:**
```sql
-- Complex retention calculation requiring multiple time periods
WITH donor_periods AS (
  SELECT
    donor_id,
    DATE_FORMAT(donation_date, '%Y-%m') as period,
    MIN(donation_date) as first_donation_date,
    COUNT(*) as donation_count,
    SUM(amount) as total_amount
  FROM pw_transactions t
  JOIN pw_donors d ON t.member_id = d.id
  WHERE t.status = 'completed'
    AND t.donation_date BETWEEN ? AND ?
    AND (t.appeal_id = ? OR ? IS NULL)
    AND (t.fundlist_id = ? OR ? IS NULL)
  GROUP BY donor_id, DATE_FORMAT(donation_date, '%Y-%m')
),
retention_calculation AS (
  SELECT
    current_period.period,
    COUNT(DISTINCT current_period.donor_id) as current_donors,
    COUNT(DISTINCT CASE
      WHEN previous_period.donor_id IS NOT NULL
      THEN current_period.donor_id
    END) as repeat_donors,
    COUNT(DISTINCT previous_period.donor_id) as previous_period_donors
  FROM donor_periods current_period
  LEFT JOIN donor_periods previous_period
    ON current_period.donor_id = previous_period.donor_id
    AND previous_period.period = DATE_FORMAT(
      DATE_SUB(STR_TO_DATE(CONCAT(current_period.period, '-01'), '%Y-%m-%d'), INTERVAL 1 MONTH),
      '%Y-%m'
    )
  GROUP BY current_period.period
)
SELECT
  period,
  current_donors as total_donors,
  repeat_donors,
  current_donors - repeat_donors as new_donors,
  CASE
    WHEN previous_period_donors > 0
    THEN ROUND((repeat_donors / previous_period_donors) * 100, 2)
    ELSE 0
  END as retention_rate_percentage,
  previous_period_donors
FROM retention_calculation
ORDER BY period;
```

**Retention Calculation Logic:**
- Retention Rate = (Repeat Donors in Current Period / Total Donors from Previous Period) × 100
- Repeat Donor: Donor who made donations in both current and previous periods
- New Donor: Donor making first donation in current period
- Cohort-based tracking for accurate retention measurement

### API Integration Context
**Donor Retention API Endpoint:**
- `GET /api/v1/analytics/donor-retention` - Primary retention analytics endpoint

**API Response Structure:**
```typescript
interface DonorRetentionResponse {
  data: {
    currentPeriod: {
      totalDonors: number;
      newDonors: number;
      repeatDonors: number;
      averageRetentionRate: number;
      peakRetentionPeriod: {
        period: string;
        rate: number;
      };
    };
    comparisonPeriod?: {
      totalDonors: number;
      newDonors: number;
      repeatDonors: number;
      averageRetentionRate: number;
    };
    timeSeriesData: Array<{
      period: string; // 'YYYY-MM' format
      totalDonors: number;
      newDonors: number;
      repeatDonors: number;
      retentionRate: number; // Percentage (0-100)
      previousPeriodDonors: number;
    }>;
    comparisonTimeSeriesData?: Array<{
      period: string;
      totalDonors: number;
      newDonors: number;
      repeatDonors: number;
      retentionRate: number;
    }>;
    retentionTrend: {
      direction: 'improving' | 'declining' | 'stable';
      changePercentage: number; // Percentage point change
      trend: 'up' | 'down' | 'flat';
    };
  };
  meta: {
    granularity: 'monthly' | 'quarterly';
    cohortBased: boolean;
    cached: boolean;
    lastUpdated: string;
  };
}
```

### Recharts Implementation Context
**Retention Rate Line Chart Configuration:**
```typescript
// Donor retention line chart with percentage Y-axis
<ResponsiveContainer width="100%" height={400}>
  <LineChart data={retentionData} margin={{ top: 20, right: 30, left: 20, bottom: 20 }}>
    <CartesianGrid strokeDasharray="3 3" />
    <XAxis
      dataKey="period"
      tickFormatter={(period) => format(new Date(period + '-01'), 'MMM yyyy')}
    />
    <YAxis
      domain={[0, 100]}
      tickFormatter={(value) => `${value}%`}
    />
    <Tooltip
      formatter={(value, name) => [`${value}%`, name]}
      labelFormatter={(period) => format(new Date(period + '-01'), 'MMMM yyyy')}
      content={<RetentionTooltip />}
    />
    <Legend />

    {/* Retention quality zones */}
    <ReferenceLine y={60} stroke="#22c55e" strokeDasharray="2 2" label="Good Retention" />
    <ReferenceLine y={40} stroke="#f59e0b" strokeDasharray="2 2" label="Moderate" />

    <Line
      type="monotone"
      dataKey="retentionRate"
      stroke="#22c55e"
      strokeWidth={3}
      name="Retention Rate"
      dot={{ fill: '#22c55e', r: 5 }}
    />
    {comparisonData && (
      <Line
        type="monotone"
        dataKey="comparisonRetentionRate"
        stroke="#94a3b8"
        strokeWidth={2}
        strokeDasharray="5 5"
        name="Comparison Period"
        dot={{ fill: '#94a3b8', r: 4 }}
      />
    )}
  </LineChart>
</ResponsiveContainer>
```

**Custom Retention Tooltip Component:**
```typescript
const RetentionTooltip = ({ active, payload, label }: any) => {
  if (active && payload && payload.length) {
    const data = payload[0].payload;

    return (
      <div className="bg-white p-3 border border-gray-200 rounded shadow-lg">
        <p className="font-semibold text-gray-800">
          {format(new Date(label + '-01'), 'MMMM yyyy')}
        </p>
        <p className="text-lg font-bold text-green-600">
          Retention Rate: {data.retentionRate}%
        </p>
        <div className="mt-2 text-sm text-gray-600">
          <p>Total Donors: {data.totalDonors.toLocaleString()}</p>
          <p>Repeat Donors: {data.repeatDonors.toLocaleString()}</p>
          <p>New Donors: {data.newDonors.toLocaleString()}</p>
          <p>Previous Period: {data.previousPeriodDonors.toLocaleString()}</p>
        </div>
      </div>
    );
  }
  return null;
};
```

### Retention Calculation Implementation
**Retention Rate Calculation Utilities:**
```typescript
interface DonorRetentionPeriod {
  period: string;
  totalDonors: number;
  newDonors: number;
  repeatDonors: number;
  previousPeriodDonors: number;
}

export class DonorRetentionCalculations {
  /**
   * Calculate retention rate for a period
   * Retention Rate = (Repeat Donors / Previous Period Total Donors) × 100
   */
  static calculateRetentionRate(
    repeatDonors: number,
    previousPeriodDonors: number
  ): number {
    if (previousPeriodDonors === 0) return 0;
    return Math.round((repeatDonors / previousPeriodDonors) * 100 * 100) / 100; // Round to 2 decimal places
  }

  /**
   * Identify repeat donors between consecutive periods
   */
  static identifyRepeatDonors(
    currentPeriodDonors: string[],
    previousPeriodDonors: string[]
  ): string[] {
    const previousSet = new Set(previousPeriodDonors);
    return currentPeriodDonors.filter(donorId => previousSet.has(donorId));
  }

  /**
   * Calculate retention trend over multiple periods
   */
  static calculateRetentionTrend(
    retentionRates: number[]
  ): { direction: 'improving' | 'declining' | 'stable'; changePercentage: number } {
    if (retentionRates.length < 2) {
      return { direction: 'stable', changePercentage: 0 };
    }

    const firstHalf = retentionRates.slice(0, Math.floor(retentionRates.length / 2));
    const secondHalf = retentionRates.slice(Math.floor(retentionRates.length / 2));

    const firstAvg = firstHalf.reduce((a, b) => a + b, 0) / firstHalf.length;
    const secondAvg = secondHalf.reduce((a, b) => a + b, 0) / secondHalf.length;

    const change = secondAvg - firstAvg;
    const threshold = 2; // 2 percentage point threshold for significance

    if (Math.abs(change) < threshold) {
      return { direction: 'stable', changePercentage: change };
    }

    return {
      direction: change > 0 ? 'improving' : 'declining',
      changePercentage: change
    };
  }
}
```

### Data Table Implementation Context
**Retention Data Table Structure:**
```typescript
interface RetentionTableRow {
  period: string;
  totalDonors: number;
  newDonors: number;
  repeatDonors: number;
  retentionRate: number;
  previousPeriodDonors: number;
  comparisonRetentionRate?: number;
  retentionChange?: number;
  retentionTrend?: 'up' | 'down' | 'flat';
}

const RetentionTableColumns = [
  {
    key: 'period',
    label: 'Period',
    sortable: true,
    formatter: (value: string) => format(new Date(value + '-01'), 'MMM yyyy')
  },
  {
    key: 'totalDonors',
    label: 'Total Donors',
    sortable: true,
    formatter: (value: number) => value.toLocaleString()
  },
  {
    key: 'newDonors',
    label: 'New Donors',
    sortable: true,
    formatter: (value: number) => value.toLocaleString()
  },
  {
    key: 'repeatDonors',
    label: 'Repeat Donors',
    sortable: true,
    formatter: (value: number) => value.toLocaleString()
  },
  {
    key: 'retentionRate',
    label: 'Retention Rate',
    sortable: true,
    formatter: (value: number) => `${value}%`,
    cellClassName: (value: number) =>
      value >= 60 ? 'text-green-600 font-semibold' :
      value >= 40 ? 'text-yellow-600 font-semibold' :
      'text-red-600 font-semibold'
  }
];
```

### Performance Optimization Context
**Retention Query Optimization:**
```typescript
// Optimized retention data fetching with proper caching
const useDonorRetentionData = (filters: FilterState) => {
  return useQuery({
    queryKey: ['donor-retention', filters],
    queryFn: async () => {
      // Retention calculations are complex, use longer cache times
      const params = new URLSearchParams({
        startDate: filters.dateRange.startDate.toISOString(),
        endDate: filters.dateRange.endDate.toISOString(),
        granularity: 'monthly',
        ...(filters.selectedAppeal && { appealId: filters.selectedAppeal.id }),
        ...(filters.selectedFund && { fundId: filters.selectedFund.id })
      });

      const response = await fetch(`/api/v1/analytics/donor-retention?${params}`);
      return response.json();
    },
    staleTime: 10 * 60 * 1000, // 10 minutes cache for complex calculations
    refetchOnWindowFocus: false,
  });
};
```

### File Locations and Naming Conventions
**Chart Component Files:**
- `apps/web/components/charts/DonorRetentionChart.tsx` - Main retention chart
- `apps/web/components/charts/RetentionTooltip.tsx` - Custom tooltip component
- `apps/web/components/tables/DonorRetentionTable.tsx` - Retention data table

**API Route Files:**
- `apps/web/app/api/v1/analytics/donor-retention/route.ts` - Retention analytics endpoint

**Calculation and Utility Files:**
- `apps/web/lib/calculations/donorRetentionCalculations.ts` - Retention math utilities
- `apps/web/hooks/useDonorRetentionData.ts` - Data fetching hook
- `packages/shared/types/donorRetention.ts` - TypeScript interfaces

### Integration with Filter System
**Filter Integration Pattern:**
```typescript
const DonorRetentionChart = ({ initialData }: DonorRetentionChartProps) => {
  const { dateRange, selectedAppeal, selectedFund } = useFilterStore();
  const comparison = useComparisonStore(state =>
    state.getChartComparison('donor-retention')
  );

  const { data, isLoading } = useDonorRetentionData({
    startDate: dateRange.startDate,
    endDate: dateRange.endDate,
    appealId: selectedAppeal?.id,
    fundId: selectedFund?.id,
    compareStartDate: comparison?.startDate,
    compareEndDate: comparison?.endDate
  });

  // Chart rendering with retention-specific styling
};
```

### Retention Rate Color Coding System
**Visual Retention Indicators:**
```typescript
const getRetentionRateColor = (rate: number): string => {
  if (rate >= 60) return '#22c55e'; // Green - Good retention
  if (rate >= 40) return '#f59e0b'; // Amber - Moderate retention
  return '#ef4444'; // Red - Concerning retention
};

const getRetentionQualityLabel = (rate: number): string => {
  if (rate >= 60) return 'Good';
  if (rate >= 40) return 'Moderate';
  return 'Needs Attention';
};
```

## Testing

### Testing Standards [Source: docs/architecture.md#technology-stack-table]
**Testing Framework:** Jest + React Testing Library for component testing
**Test File Location:** `__tests__/` directories alongside retention components
**Testing Patterns:**
- Component rendering tests for retention chart and table components
- Retention calculation logic tests with various donor scenarios
- Filter integration tests ensuring proper retention analysis
- API integration tests with complex retention queries

**Specific Testing Requirements for This Story:**
- Donor retention chart rendering with percentage-based visualization
- Retention calculation accuracy with edge cases (zero donors, first periods)
- Comparison overlay functionality with retention rate changes
- Data table rendering with retention-specific color coding
- Filter integration affecting retention calculations correctly
- Interactive tooltip display with comprehensive retention metrics
- Performance testing for complex retention query calculations

**Test Files to Create:**
- `apps/web/components/charts/__tests__/DonorRetentionChart.test.tsx` - Chart component tests
- `apps/web/components/tables/__tests__/DonorRetentionTable.test.tsx` - Table component tests
- `apps/web/lib/calculations/__tests__/donorRetentionCalculations.test.ts` - Calculation logic tests
- `apps/web/hooks/__tests__/useDonorRetentionData.test.ts` - Data fetching hook tests
- `apps/web/__tests__/api/donor-retention.test.ts` - API endpoint tests

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|---------|
| 2025-09-26 | 1.0 | Initial story creation with comprehensive donor retention analytics implementation | Claude (Story Agent) |

## Dev Agent Record

*This section will be populated by the development agent during implementation*

### Agent Model Used
*To be filled by dev agent*

### Debug Log References
*To be filled by dev agent*

### Completion Notes List
*To be filled by dev agent*

### File List
*To be filled by dev agent*

## QA Results

*Results from QA Agent review will be populated here*