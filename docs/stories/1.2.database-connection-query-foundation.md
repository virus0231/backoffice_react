# Story 1.2: Database Connection & Query Foundation

## Status
Draft

## Story

**As a** development team,
**I want** secure phpMySQL database connectivity with connection pooling and basic query structure,
**so that** all dashboard charts can efficiently access fundraising data without performance bottlenecks.

## Acceptance Criteria

1. Database connection configuration with environment variable management
2. Connection pooling implementation supporting multiple simultaneous queries
3. Basic database utility functions for parameterized queries with filtering support
4. Error handling and logging for database connection issues
5. Query performance monitoring and timeout configuration
6. Test connection endpoint confirming database accessibility and basic data retrieval

## Tasks / Subtasks

- [ ] Set up database connection configuration (AC: 1)
  - [ ] Configure environment variables for database credentials in `.env.local`
  - [ ] Create database connection configuration in `packages/database/connection.ts`
  - [ ] Implement environment variable validation with proper error messages
  - [ ] Add connection string validation and format checking
  - [ ] Test environment configuration across development and production modes
- [ ] Implement Sequelize connection pooling (AC: 2)
  - [ ] Install Sequelize dependencies: `npm install sequelize mysql2 sequelize-typescript`
  - [ ] Configure Sequelize instance with MySQL dialect in `packages/database/sequelize.ts`
  - [ ] Set up connection pooling with cPanel optimized settings (max: 10, min: 2, idle: 10000)
  - [ ] Configure connection retry logic and timeout handling
  - [ ] Test multiple simultaneous connections and pool management
- [ ] Create basic database models and utilities (AC: 3)
  - [ ] Define core Sequelize models in `packages/database/models/`
  - [ ] Create Donation model mapping to `pw_transactions` table
  - [ ] Create Donor model mapping to `pw_donors` table
  - [ ] Create Campaign model mapping to `pw_appeal` table
  - [ ] Create Fund model mapping to `pw_fundlist` table
  - [ ] Set up model associations (Donation belongs to Donor, Campaign, Fund)
  - [ ] Create query builder utilities for parameterized filtering
- [ ] Implement error handling and logging system (AC: 4)
  - [ ] Install Winston logging: `npm install winston`
  - [ ] Configure structured logging for database operations
  - [ ] Create error handling middleware for database connection failures
  - [ ] Implement graceful degradation for connection issues
  - [ ] Add query error logging with sanitized parameters
  - [ ] Create database health check logging
- [ ] Set up query performance monitoring (AC: 5)
  - [ ] Configure Sequelize query logging and timing
  - [ ] Implement query timeout settings (30 seconds default)
  - [ ] Add slow query detection and logging
  - [ ] Create performance metrics collection for optimization
  - [ ] Set up query execution time monitoring
  - [ ] Add database connection status monitoring
- [ ] Create database test endpoint and validation (AC: 6)
  - [ ] Build API route `/api/v1/test/database-connection` for connection testing
  - [ ] Implement basic data retrieval test querying sample records
  - [ ] Create database schema validation checking required tables
  - [ ] Add connection pool status endpoint for monitoring
  - [ ] Test query execution with basic donation data retrieval
  - [ ] Validate model associations and relationships work correctly

## Dev Notes

### Previous Story Insights
**Story 1.1 Dependencies:** This story builds directly on the project foundation established in Story 1.1, requiring the Next.js application structure and packages directory setup.

### Technical Architecture Context
**Database Integration Strategy:** [Source: docs/architecture.md#data-models, docs/prd.md#technical-assumptions]
- Direct phpMySQL connection with optimized connection pooling and query caching
- Connection pooling optimized for cPanel shared hosting constraints
- Sequelize ORM with MySQL integration for type-safe database operations
- Real-time data aggregation with performance optimization for 3GB+ database

**Sequelize Model Architecture:** [Source: docs/architecture.md#sequelize-model-definitions]
```typescript
// Core model structure for pw_transactions table
DonationModel.init({
  id: { type: DataTypes.STRING, primaryKey: true, field: 'id' },
  orderId: { type: DataTypes.STRING, allowNull: false, field: 'order_id' },
  donorId: { type: DataTypes.STRING, allowNull: false, field: 'member_id' },
  campaignId: { type: DataTypes.STRING, allowNull: true, field: 'appeal_id' },
  fundId: { type: DataTypes.STRING, allowNull: true, field: 'fundlist_id' },
  amount: { type: DataTypes.DECIMAL(10, 2), allowNull: false, field: 'amount' },
  frequency: { type: DataTypes.INTEGER, allowNull: false, field: 'freq' },
  status: { type: DataTypes.STRING, allowNull: false, field: 'status' },
  paymentMethod: { type: DataTypes.STRING, allowNull: false, field: 'payment_method' },
  donationDate: { type: DataTypes.DATE, allowNull: false, field: 'donation_date' },
  createdAt: { type: DataTypes.DATE, allowNull: false, field: 'created_at' }
}, {
  sequelize,
  tableName: 'pw_transactions',
  timestamps: false
});
```

**Connection Pool Configuration:** [Source: docs/architecture.md#platform-and-infrastructure]
- cPanel Node.js hosting environment with manual deployment
- Connection pooling configuration for shared hosting constraints
- Built-in Next.js optimization for static assets and API routes
- Performance optimization targeting sub-3-second load times

**Query Collaboration Workflow:** [Source: docs/prd.md#query-collaboration-process]
1. Agent identifies specific data fields, time filtering, aggregation needs
2. User provides base query working with existing phpMySQL database
3. Agent optimization process: Sequelize ORM implementation with universal filtering
4. Validation cycle for data accuracy and performance confirmation

### Database Schema Context
**Core Data Entities:** [Source: docs/architecture.md#core-data-entities]
- `pw_transactions` - Primary donations table with order_id, member_id, appeal_id, fundlist_id
- `pw_donors` - Donor information with first_name, last_name, email, address fields
- `pw_appeal` - Campaign/appeal data with appeal_name, start_date, end_date, goal_amount
- `pw_fundlist` - Fund categories with fund_name, description, category, is_active

**Critical Query Logic:** [Source: docs/architecture.md#calculated-fields-and-query-helpers]
- First installments: `freq=1 AND order_id NOT REGEXP '_'`
- One-time donations: `freq=0`
- Recurring donations: `freq>1` or `order_id REGEXP '_'`
- Status filtering: `status='completed'` for revenue calculations

### File Locations and Naming Conventions
**Database Configuration Files:**
- `packages/database/connection.ts` - Main database connection setup
- `packages/database/sequelize.ts` - Sequelize instance configuration
- `packages/database/models/` - Individual model definitions
- `packages/database/helpers/` - Query utilities and calculated fields

**Model Files Structure:**
- `packages/database/models/Donation.ts` - DonationModel for pw_transactions
- `packages/database/models/Donor.ts` - DonorModel for pw_donors
- `packages/database/models/Campaign.ts` - CampaignModel for pw_appeal
- `packages/database/models/Fund.ts` - FundModel for pw_fundlist
- `packages/database/associations.ts` - Model relationship definitions

**API Route Structure:**
- `apps/web/app/api/v1/test/database-connection/route.ts` - Connection test endpoint
- `apps/web/app/api/v1/health/database/route.ts` - Database health monitoring

### Environment Configuration
**Required Environment Variables:**
```
DB_HOST=your_cpanel_mysql_host
DB_NAME=your_database_name
DB_USER=your_database_user
DB_PASSWORD=your_database_password
DB_PORT=3306
DB_POOL_MAX=10
DB_POOL_MIN=2
DB_POOL_IDLE=10000
DB_QUERY_TIMEOUT=30000
```

**cPanel Deployment Considerations:**
- Manual deployment process without infrastructure as code
- Node.js application targeting cPanel hosting environment
- Connection pooling optimized for shared hosting limitations
- Environment variable management for production deployment

### Performance Requirements Context
**Database Performance Targets:** [Source: docs/prd.md#non-functional-requirements]
- Dashboard load times must be under 3 seconds for all visualizations
- Handle complex analytical queries without impacting operational systems
- Support concurrent usage by multiple users without performance degradation
- Optimized database connection pooling for handling multiple simultaneous chart data requests

**Query Optimization Strategies:**
- Indexed queries for date ranges and relationships on 3GB+ database
- Connection pooling with appropriate limits for cPanel shared hosting
- Query caching and performance monitoring
- Timeout configuration preventing long-running queries

## Testing

### Testing Standards [Source: docs/architecture.md#technology-stack-table]
**Testing Framework:** Jest + Supertest for API route testing with database mocking
**Test File Location:** `__tests__/` directories alongside database utility files
**Testing Patterns:**
- Database connection and pool management tests
- Model definition and association validation tests
- Query performance and timeout testing
- Environment configuration validation tests

**Specific Testing Requirements for This Story:**
- Database connection establishment and failure scenarios
- Connection pool behavior under concurrent load
- Sequelize model mapping to existing database schema
- Query parameter sanitization and SQL injection prevention
- Environment variable validation and error handling
- API endpoint response validation for test routes

**Test Files to Create:**
- `packages/database/__tests__/connection.test.ts` - Connection and pooling tests
- `packages/database/__tests__/models.test.ts` - Model definition tests
- `packages/database/__tests__/queries.test.ts` - Query utility tests
- `apps/web/__tests__/api/database.test.ts` - Database API endpoint tests

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|---------|
| 2025-09-26 | 1.0 | Initial story creation with comprehensive database foundation | Claude (Story Agent) |

## Dev Agent Record

*This section will be populated by the development agent during implementation*

### Agent Model Used
*To be filled by dev agent*

### Debug Log References
*To be filled by dev agent*

### Completion Notes List
*To be filled by dev agent*

### File List
*To be filled by dev agent*

## QA Results

*Results from QA Agent review will be populated here*