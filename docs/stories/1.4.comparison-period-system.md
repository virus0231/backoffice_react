# Story 1.4: Comparison Period System

## Status
Draft

## Story

**As a** fundraising analyst,
**I want** individual chart comparison capabilities with smart date validation,
**so that** I can overlay different time periods on each chart to identify trends and performance changes.

## Acceptance Criteria

1. Individual comparison toggle for each chart with calendar picker interface
2. Smart date validation preventing overlapping periods with main date range
3. Comparison state management integrated with global filter system
4. Visual indicators showing comparison period selection and status
5. Percentage change calculations between current and comparison periods
6. Comparison data state shared across chart components and data tables

## Tasks / Subtasks

- [ ] Create comparison toggle component (AC: 1)
  - [ ] Build ComparisonToggle component in `apps/web/components/charts/ComparisonToggle.tsx`
  - [ ] Implement toggle switch with calendar picker integration
  - [ ] Create comparison date range picker with preset options
  - [ ] Add comparison period selection modal/popover interface
  - [ ] Style component matching FundraisUP comparison controls
  - [ ] Integrate with individual chart components as optional prop
- [ ] Implement smart date validation system (AC: 2)
  - [ ] Create comparison validation utilities in `apps/web/lib/validation/comparisonDates.ts`
  - [ ] Implement overlap prevention logic between main and comparison periods
  - [ ] Add validation for reasonable comparison periods (not too far in past/future)
  - [ ] Create date range conflict detection and resolution
  - [ ] Add validation feedback messages for invalid selections
  - [ ] Ensure comparison periods respect main filter date boundaries
- [ ] Extend Zustand store for comparison state (AC: 3)
  - [ ] Update filterStore to include per-chart comparison state
  - [ ] Create comparison state interface: `ChartComparisonState { enabled, startDate, endDate }`
  - [ ] Add comparison actions: `setChartComparison`, `clearChartComparison`, `toggleChartComparison`
  - [ ] Implement per-chart comparison state with chart ID mapping
  - [ ] Add comparison state persistence with localStorage integration
  - [ ] Create comparison state validation on store updates
- [ ] Build comparison visual indicators (AC: 4)
  - [ ] Create ComparisonIndicator component in `apps/web/components/charts/ComparisonIndicator.tsx`
  - [ ] Implement comparison period display badges showing selected dates
  - [ ] Add comparison status indicators (active/inactive) for each chart
  - [ ] Create comparison period summary display in filter bar
  - [ ] Style indicators matching FundraisUP comparison UI design
  - [ ] Add clear/remove comparison period buttons for each chart
- [ ] Implement percentage change calculations (AC: 5)
  - [ ] Create calculation utilities in `apps/web/lib/calculations/percentageChange.ts`
  - [ ] Implement percentage change formulas: `((current - comparison) / comparison) * 100`
  - [ ] Add growth/decline indicators with appropriate color coding (green/red)
  - [ ] Handle edge cases: zero values, null comparisons, infinite percentages
  - [ ] Create formatted percentage display with proper rounding
  - [ ] Add trend direction indicators (up/down arrows) with percentage values
- [ ] Integrate comparison data with API and charts (AC: 6)
  - [ ] Update API endpoints to accept comparison date parameters
  - [ ] Modify chart data fetching to include comparison period queries
  - [ ] Create comparison data overlay logic for Recharts components
  - [ ] Implement dual-line chart rendering for current vs. comparison periods
  - [ ] Add comparison data to chart data tables with side-by-side metrics
  - [ ] Ensure comparison data reflects current filter selections (appeals, funds, frequency)

## Dev Notes

### Previous Story Insights
**Story Dependencies:** This story builds on the universal filter system from Story 1.3 and database foundation from Story 1.2, requiring integration with existing filter state management.

### Technical Architecture Context
**Comparison System Requirements:** [Source: docs/prd.md#functional-requirements]
- Individual chart comparison controls with calendar picker (FR4)
- Smart date validation preventing overlapping date selections (FR5)
- Dual-line chart visualization showing current and comparison periods with percentage change indicators (FR6)

**Chart Integration Pattern:** [Source: docs/architecture.md#component-architecture]
```typescript
// Each chart component will include comparison functionality
interface ChartProps {
  initialData: ChartData;
  enableComparison?: boolean;
  comparisonData?: ChartData;
}

// Usage example
<TotalRaisedChart
  initialData={data.current}
  enableComparison={true}
  comparisonData={data.comparison}
/>
```

**Comparison State Management:** [Source: docs/architecture.md#state-management-with-zustand]
```typescript
interface ComparisonState {
  comparisons: Map<string, ChartComparison>; // chartId -> comparison config

  setChartComparison: (chartId: string, comparison: ChartComparison) => void;
  clearChartComparison: (chartId: string) => void;
  getChartComparison: (chartId: string) => ChartComparison | null;
}

interface ChartComparison {
  enabled: boolean;
  startDate: Date;
  endDate: Date;
  label?: string; // e.g., "vs. Last Year"
}
```

### Visual Design Context
**Comparison UI Elements:** [Source: docs/prd.md#user-interface-design-goals]
- 100% pixel-perfect replication of FundraisUP comparison interface
- Toggle switches matching reference design styling
- Comparison period badges and indicators
- Percentage change indicators with green (positive) and red (negative) color coding

**Chart Visualization Patterns:**
- Dual-line charts with distinct colors for current vs. comparison periods
- Overlay visualizations maintaining chart readability
- Comparison data integration in chart tooltips and legends
- Data table enhancements showing side-by-side comparison metrics

### API Integration Context
**Enhanced API Response Structure:** [Source: docs/architecture.md#api-specification]
```typescript
// Enhanced API response with comparison data
{
  "data": {
    "currentPeriod": {
      "totalRaised": 125450.00,
      "donationCount": 847,
      "averageDonation": 148.11
    },
    "comparisonPeriod": {
      "totalRaised": 98320.00,
      "donationCount": 723,
      "averageDonation": 135.96
    },
    "growth": {
      "amount": 27.6,
      "percentage": 28.1,
      "direction": "up"
    }
  }
}
```

**API Parameter Extensions:**
- `compareStartDate` (ISO string): Comparison period start
- `compareEndDate` (ISO string): Comparison period end
- Validation ensuring non-overlapping date ranges
- Query optimization for dual-period data fetching

### Date Validation Logic
**Overlap Prevention Algorithm:**
```typescript
function validateComparisonPeriod(
  mainStart: Date,
  mainEnd: Date,
  compStart: Date,
  compEnd: Date
): ValidationResult {
  // Prevent overlap
  if (compEnd >= mainStart && compStart <= mainEnd) {
    return { valid: false, error: "Comparison period cannot overlap with main period" };
  }

  // Ensure reasonable bounds
  const maxLookback = 730; // 2 years
  if (differenceInDays(new Date(), compStart) > maxLookback) {
    return { valid: false, error: "Comparison period too far in the past" };
  }

  return { valid: true };
}
```

### Performance Considerations
**Comparison Query Optimization:**
- Efficient dual-period queries minimizing database overhead
- Caching strategy for comparison data with appropriate TTL
- Lazy loading of comparison data only when enabled
- Query combination preventing redundant database calls

### File Locations and Naming Conventions
**Comparison Component Files:**
- `apps/web/components/charts/ComparisonToggle.tsx` - Chart comparison toggle
- `apps/web/components/charts/ComparisonIndicator.tsx` - Visual indicators
- `apps/web/components/charts/ComparisonDatePicker.tsx` - Date selection
- `apps/web/components/charts/PercentageChangeDisplay.tsx` - Growth indicators

**State and Utility Files:**
- `apps/web/stores/comparisonStore.ts` - Comparison state management (or extend filterStore)
- `apps/web/lib/validation/comparisonDates.ts` - Date validation utilities
- `apps/web/lib/calculations/percentageChange.ts` - Calculation utilities
- `apps/web/hooks/useComparison.ts` - Comparison functionality hook

**Enhanced Chart Component Files:**
- `apps/web/components/charts/BaseChart.tsx` - Base chart with comparison support
- `apps/web/components/charts/ChartWrapper.tsx` - Wrapper handling comparison logic

### Integration with Existing Components
**Chart Component Enhancement Pattern:**
```typescript
// Enhanced chart component structure
export function TotalRaisedChart({ initialData }: TotalRaisedChartProps) {
  const { dateRange, selectedAppeal, selectedFund } = useFilterStore();
  const comparison = useComparisonStore(state => state.getChartComparison('total-raised'));

  const { data, comparisonData } = useDashboardQuery({
    endpoint: '/api/v1/analytics/total-raised',
    params: {
      startDate: dateRange.startDate,
      endDate: dateRange.endDate,
      compareStartDate: comparison?.startDate,
      compareEndDate: comparison?.endDate,
      // ... other filters
    }
  });

  return (
    <ChartWrapper chartId="total-raised" enableComparison>
      <ResponsiveContainer>
        <LineChart>
          <Line dataKey="current" stroke="#3b82f6" name="Current Period" />
          {comparisonData && (
            <Line dataKey="comparison" stroke="#94a3b8" name="Comparison Period" />
          )}
        </LineChart>
      </ResponsiveContainer>
    </ChartWrapper>
  );
}
```

### Recharts Integration
**Dual-Line Chart Implementation:**
```typescript
// Recharts configuration for comparison visualization
const chartData = useMemo(() => {
  if (!comparisonData) return currentData;

  return currentData.map((current, index) => ({
    ...current,
    comparison: comparisonData[index]?.value || null
  }));
}, [currentData, comparisonData]);

// Chart rendering with comparison lines
<LineChart data={chartData}>
  <Line
    dataKey="current"
    stroke="#3b82f6"
    strokeWidth={2}
    name="Current Period"
  />
  <Line
    dataKey="comparison"
    stroke="#94a3b8"
    strokeWidth={2}
    strokeDasharray="5 5"
    name="Comparison Period"
  />
  <Legend />
  <Tooltip formatter={(value, name) => [value, name]} />
</LineChart>
```

## Testing

### Testing Standards [Source: docs/architecture.md#technology-stack-table]
**Testing Framework:** Jest + React Testing Library for component testing
**Test File Location:** `__tests__/` directories alongside comparison components
**Testing Patterns:**
- Component rendering tests for comparison UI elements
- State management tests for comparison store functionality
- Date validation tests for overlap prevention logic
- Integration tests for chart comparison data overlay

**Specific Testing Requirements for This Story:**
- Comparison toggle component functionality and date picker integration
- Smart date validation preventing overlapping periods
- Comparison state persistence and chart-specific state management
- Visual indicator rendering and status updates
- Percentage change calculation accuracy and edge case handling
- API integration with comparison date parameters
- Chart rendering with dual-line comparison visualization

**Test Files to Create:**
- `apps/web/components/charts/__tests__/ComparisonToggle.test.tsx` - Toggle component tests
- `apps/web/components/charts/__tests__/ComparisonIndicator.test.tsx` - Visual indicator tests
- `apps/web/lib/validation/__tests__/comparisonDates.test.ts` - Date validation tests
- `apps/web/lib/calculations/__tests__/percentageChange.test.ts` - Calculation tests
- `apps/web/stores/__tests__/comparisonStore.test.ts` - State management tests
- `apps/web/__tests__/api/comparison-integration.test.ts` - API integration tests

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|---------|
| 2025-09-26 | 1.0 | Initial story creation with comprehensive comparison system implementation | Claude (Story Agent) |

## Dev Agent Record

*This section will be populated by the development agent during implementation*

### Agent Model Used
*To be filled by dev agent*

### Debug Log References
*To be filled by dev agent*

### Completion Notes List
*To be filled by dev agent*

### File List
*To be filled by dev agent*

## QA Results

*Results from QA Agent review will be populated here*