# Story 2.3: First Time Donors Acquisition Chart

## Status
Draft

## Story

**As a** fundraising manager,
**I want** first-time donor acquisition tracking with trend analysis,
**so that** I can monitor new donor growth and evaluate acquisition campaign effectiveness.

## Acceptance Criteria

1. Time-series chart displaying first-time donor counts over selected period
2. New donor identification logic preventing duplicate counting across time periods
3. Comparison period functionality showing acquisition trend changes
4. Data table with first-time donor metrics, conversion rates, and acquisition sources
5. Integration with appeals and frequency filters for campaign-specific analysis
6. Visual indicators for acquisition spikes and trend patterns
7. Export capabilities for new donor reporting and analysis

## Tasks / Subtasks

- [ ] Create FirstTimeDonorsChart component (AC: 1)
  - [ ] Build FirstTimeDonorsChart component in `apps/web/components/charts/FirstTimeDonorsChart.tsx`
  - [ ] Implement Recharts LineChart with first-time donor count time-series data
  - [ ] Configure chart with appropriate Y-axis scaling for donor count ranges
  - [ ] Add time period X-axis with proper date formatting (daily/weekly/monthly)
  - [ ] Style chart with acquisition-focused color scheme (blue for new donor growth)
  - [ ] Create chart loading skeleton and error state handling
- [ ] Implement new donor identification logic (AC: 2)
  - [ ] Create donor identification utilities in `apps/web/lib/calculations/firstTimeDonorCalculations.ts`
  - [ ] Implement first-time donor detection: donors with no prior donation history
  - [ ] Add logic preventing duplicate counting when time periods overlap
  - [ ] Create efficient donor history lookback queries for accurate identification
  - [ ] Handle edge cases: donors with gaps in giving, reactivated lapsed donors
  - [ ] Add validation ensuring accurate first-time donor classification
- [ ] Add comparison period functionality (AC: 3)
  - [ ] Integrate comparison system from Story 1.4 with acquisition chart
  - [ ] Implement dual-line chart showing current vs. comparison period acquisitions
  - [ ] Calculate acquisition trend changes and growth percentages
  - [ ] Add visual indicators for acquisition improvement/decline (green/red arrows)
  - [ ] Create comparison legend with clear period identification
  - [ ] Include acquisition rate change display in chart header
- [ ] Build first-time donors data table (AC: 4)
  - [ ] Create FirstTimeDonorsTable component in `apps/web/components/tables/FirstTimeDonorsTable.tsx`
  - [ ] Implement columns: Date, New Donors, Total Amount, Average Gift, Conversion Rate
  - [ ] Add acquisition source breakdown when source data is available
  - [ ] Include sortable functionality for all numerical columns
  - [ ] Add comparison period data when overlay is active
  - [ ] Create acquisition metrics summary: cumulative acquisitions, growth rates
- [ ] Integrate appeals and frequency filtering (AC: 5)
  - [ ] Connect chart to global filter state for campaign-specific analysis
  - [ ] Implement appeals filtering to track acquisition by specific campaigns
  - [ ] Add frequency filtering for first-time donor analysis (one-time vs. recurring new donors)
  - [ ] Ensure first-time donor logic respects filter boundaries
  - [ ] Support date range filtering for acquisition trend analysis
  - [ ] Add real-time chart updates when filter selections change
- [ ] Create acquisition spike detection and indicators (AC: 6)
  - [ ] Implement spike detection algorithm for unusual acquisition increases
  - [ ] Add visual markers on chart for significant acquisition events
  - [ ] Create trend line overlay showing acquisition direction
  - [ ] Add acquisition rate annotations for notable periods
  - [ ] Include seasonal pattern recognition for acquisition trends
  - [ ] Style indicators matching FundraisUP design with clear visual hierarchy
- [ ] Implement export functionality (AC: 7)
  - [ ] Build export controls for first-time donor data and visualizations
  - [ ] Create CSV export with acquisition metrics and donor details
  - [ ] Add chart image export functionality (PNG format)
  - [ ] Include comparison period data in exports when active
  - [ ] Create formatted reports suitable for acquisition campaign analysis
  - [ ] Add export options respecting current filter selections

## Dev Notes

### Previous Story Insights
**Story Dependencies:** This story builds on the database foundation (Story 1.2), universal filter system (Story 1.3), comparison system (Story 1.4), and follows the operational analytics patterns from Stories 2.1 and 2.2.

### Technical Architecture Context
**First-Time Donor Requirements:** [Source: docs/prd.md#functional-requirements]
- First Time Donors tracking with trend analysis and comparison capabilities (FR12)
- Integration with appeals filtering for campaign-specific analysis
- Visual indicators for acquisition spikes and trend patterns
- Export capabilities for new donor reporting and analysis

**Operational Analytics Context:** [Source: docs/prd.md#epic-2-operational-analytics-charts]
- Essential operational analytics providing insights for daily fundraising management
- First-time donor acquisition tracking for monitoring new donor growth
- Campaign effectiveness evaluation through acquisition metrics

### Database Query Logic Context
**First-Time Donor Identification Query:**
```sql
-- First-time donor identification with proper historical lookback
WITH donor_first_donations AS (
  SELECT
    member_id as donor_id,
    MIN(donation_date) as first_donation_date,
    MIN(amount) as first_donation_amount
  FROM pw_transactions
  WHERE status = 'completed'
  GROUP BY member_id
),
filtered_first_time_donors AS (
  SELECT
    fd.donor_id,
    fd.first_donation_date,
    fd.first_donation_amount,
    t.appeal_id,
    t.fundlist_id,
    t.freq,
    d.first_name,
    d.last_name,
    d.email
  FROM donor_first_donations fd
  JOIN pw_transactions t ON fd.donor_id = t.member_id AND fd.first_donation_date = t.donation_date
  JOIN pw_donors d ON fd.donor_id = d.id
  WHERE fd.first_donation_date BETWEEN ? AND ?
    AND (t.appeal_id = ? OR ? IS NULL)
    AND (t.fundlist_id = ? OR ? IS NULL)
    AND (
      (? = 'all') OR
      (? = 'one-time' AND t.freq = 0) OR
      (? = 'recurring' AND t.freq > 0)
    )
)
SELECT
  DATE(first_donation_date) as acquisition_date,
  COUNT(*) as new_donor_count,
  SUM(first_donation_amount) as total_acquisition_amount,
  AVG(first_donation_amount) as average_first_gift,
  COUNT(CASE WHEN freq = 0 THEN 1 END) as one_time_new_donors,
  COUNT(CASE WHEN freq > 0 THEN 1 END) as recurring_new_donors
FROM filtered_first_time_donors
GROUP BY DATE(first_donation_date)
ORDER BY acquisition_date;
```

**Acquisition Trend Detection Algorithm:**
```sql
-- Moving average for acquisition trend detection
SELECT
  acquisition_date,
  new_donor_count,
  AVG(new_donor_count) OVER (
    ORDER BY acquisition_date
    ROWS BETWEEN 6 PRECEDING AND CURRENT ROW
  ) as seven_day_avg,
  CASE
    WHEN new_donor_count > (
      AVG(new_donor_count) OVER (
        ORDER BY acquisition_date
        ROWS BETWEEN 6 PRECEDING AND CURRENT ROW
      ) * 1.5
    ) THEN 'spike'
    WHEN new_donor_count < (
      AVG(new_donor_count) OVER (
        ORDER BY acquisition_date
        ROWS BETWEEN 6 PRECEDING AND CURRENT ROW
      ) * 0.5
    ) THEN 'dip'
    ELSE 'normal'
  END as trend_indicator
FROM daily_acquisitions
ORDER BY acquisition_date;
```

### API Integration Context
**First-Time Donors API Endpoint:**
- `GET /api/v1/analytics/first-time-donors` - Primary acquisition analytics endpoint

**API Response Structure:**
```typescript
interface FirstTimeDonorsResponse {
  data: {
    currentPeriod: {
      totalNewDonors: number;
      totalAcquisitionAmount: number;
      averageFirstGift: number;
      oneTimeNewDonors: number;
      recurringNewDonors: number;
      acquisitionRate: number; // New donors per day
      peakAcquisitionDay: {
        date: string;
        count: number;
      };
    };
    comparisonPeriod?: {
      totalNewDonors: number;
      totalAcquisitionAmount: number;
      averageFirstGift: number;
      acquisitionRate: number;
    };
    timeSeriesData: Array<{
      date: string;
      newDonorCount: number;
      totalAmount: number;
      averageFirstGift: number;
      oneTimeCount: number;
      recurringCount: number;
      trendIndicator?: 'spike' | 'dip' | 'normal';
    }>;
    comparisonTimeSeriesData?: Array<{
      date: string;
      newDonorCount: number;
      totalAmount: number;
      averageFirstGift: number;
    }>;
    acquisitionTrend: {
      direction: 'growing' | 'declining' | 'stable';
      changePercentage: number;
      trendSlope: number; // Linear regression slope
    };
    acquisitionSpikes: Array<{
      date: string;
      count: number;
      percentageAboveAverage: number;
    }>;
  };
  meta: {
    granularity: 'daily' | 'weekly' | 'monthly';
    lookbackPeriod: string; // For historical donor verification
    cached: boolean;
    lastUpdated: string;
  };
}
```

### Recharts Implementation Context
**First-Time Donors Line Chart Configuration:**
```typescript
// Acquisition trend chart with spike indicators
<ResponsiveContainer width="100%" height={400}>
  <LineChart data={acquisitionData} margin={{ top: 20, right: 30, left: 20, bottom: 20 }}>
    <CartesianGrid strokeDasharray="3 3" />
    <XAxis
      dataKey="date"
      tickFormatter={(date) => format(new Date(date), 'MMM dd')}
    />
    <YAxis
      tickFormatter={(value) => value.toLocaleString()}
      domain={['dataMin - 5', 'dataMax + 5']}
    />
    <Tooltip content={<AcquisitionTooltip />} />
    <Legend />

    {/* Trend line */}
    <Line
      type="monotone"
      dataKey="sevenDayAverage"
      stroke="#e5e7eb"
      strokeWidth={2}
      strokeDasharray="3 3"
      dot={false}
      name="7-Day Average"
    />

    {/* Main acquisition line */}
    <Line
      type="monotone"
      dataKey="newDonorCount"
      stroke="#3b82f6"
      strokeWidth={3}
      name="New Donors"
      dot={({ payload, cx, cy }) => {
        if (payload.trendIndicator === 'spike') {
          return (
            <circle
              cx={cx}
              cy={cy}
              r={6}
              fill="#22c55e"
              stroke="#16a34a"
              strokeWidth={2}
            />
          );
        }
        return <circle cx={cx} cy={cy} r={4} fill="#3b82f6" />;
      }}
    />

    {/* Comparison period line */}
    {comparisonData && (
      <Line
        type="monotone"
        dataKey="comparisonNewDonorCount"
        stroke="#94a3b8"
        strokeWidth={2}
        strokeDasharray="5 5"
        name="Comparison Period"
        dot={{ r: 3 }}
      />
    )}
  </LineChart>
</ResponsiveContainer>
```

**Custom Acquisition Tooltip:**
```typescript
const AcquisitionTooltip = ({ active, payload, label }: any) => {
  if (active && payload && payload.length) {
    const data = payload[0].payload;
    const isSpike = data.trendIndicator === 'spike';

    return (
      <div className="bg-white p-3 border border-gray-200 rounded shadow-lg">
        <p className="font-semibold text-gray-800">
          {format(new Date(label), 'MMMM dd, yyyy')}
        </p>
        <div className="mt-2">
          <p className={`text-lg font-bold ${isSpike ? 'text-green-600' : 'text-blue-600'}`}>
            New Donors: {data.newDonorCount.toLocaleString()}
            {isSpike && <span className="ml-2 text-sm">ðŸŽ‰ Spike!</span>}
          </p>
          <p className="text-sm text-gray-600">
            Total Amount: ${data.totalAmount.toLocaleString()}
          </p>
          <p className="text-sm text-gray-600">
            Avg. First Gift: ${data.averageFirstGift.toFixed(2)}
          </p>
          <div className="mt-1 text-xs text-gray-500">
            <span>One-time: {data.oneTimeCount}</span>
            <span className="ml-3">Recurring: {data.recurringCount}</span>
          </div>
        </div>
      </div>
    );
  }
  return null;
};
```

### First-Time Donor Calculation Implementation
**Acquisition Analysis Utilities:**
```typescript
interface DonorAcquisitionData {
  date: string;
  newDonorCount: number;
  totalAmount: number;
  averageFirstGift: number;
  oneTimeCount: number;
  recurringCount: number;
}

export class FirstTimeDonorCalculations {
  /**
   * Detect acquisition spikes based on historical average
   */
  static detectAcquisitionSpikes(
    acquisitionData: DonorAcquisitionData[],
    spikeThreshold: number = 1.5
  ): Array<{ date: string; count: number; percentageAboveAverage: number }> {
    const spikes: Array<any> = [];

    for (let i = 7; i < acquisitionData.length; i++) {
      const currentCount = acquisitionData[i].newDonorCount;
      const previousWeek = acquisitionData.slice(i - 7, i);
      const weeklyAverage = previousWeek.reduce((sum, day) => sum + day.newDonorCount, 0) / 7;

      if (currentCount > weeklyAverage * spikeThreshold) {
        const percentageAbove = ((currentCount - weeklyAverage) / weeklyAverage) * 100;
        spikes.push({
          date: acquisitionData[i].date,
          count: currentCount,
          percentageAboveAverage: Math.round(percentageAbove)
        });
      }
    }

    return spikes;
  }

  /**
   * Calculate acquisition trend using linear regression
   */
  static calculateAcquisitionTrend(
    acquisitionData: DonorAcquisitionData[]
  ): { direction: 'growing' | 'declining' | 'stable'; slope: number; changePercentage: number } {
    if (acquisitionData.length < 7) {
      return { direction: 'stable', slope: 0, changePercentage: 0 };
    }

    const n = acquisitionData.length;
    const xSum = (n * (n - 1)) / 2; // Sum of indices 0 to n-1
    const ySum = acquisitionData.reduce((sum, day) => sum + day.newDonorCount, 0);
    const xySum = acquisitionData.reduce((sum, day, index) => sum + (index * day.newDonorCount), 0);
    const xSquaredSum = (n * (n - 1) * (2 * n - 1)) / 6; // Sum of squares 0^2 to (n-1)^2

    // Linear regression slope
    const slope = (n * xySum - xSum * ySum) / (n * xSquaredSum - xSum * xSum);

    // Calculate percentage change from first to last week
    const firstWeekAvg = acquisitionData.slice(0, 7).reduce((sum, day) => sum + day.newDonorCount, 0) / 7;
    const lastWeekAvg = acquisitionData.slice(-7).reduce((sum, day) => sum + day.newDonorCount, 0) / 7;
    const changePercentage = ((lastWeekAvg - firstWeekAvg) / firstWeekAvg) * 100;

    const threshold = 0.1; // Minimum slope for significant trend

    if (Math.abs(slope) < threshold) {
      return { direction: 'stable', slope, changePercentage };
    }

    return {
      direction: slope > 0 ? 'growing' : 'declining',
      slope,
      changePercentage
    };
  }

  /**
   * Calculate acquisition conversion rates
   */
  static calculateConversionMetrics(
    newDonors: number,
    totalVisitors?: number,
    emailSubscribers?: number
  ) {
    return {
      visitorConversionRate: totalVisitors ? (newDonors / totalVisitors) * 100 : null,
      subscriberConversionRate: emailSubscribers ? (newDonors / emailSubscribers) * 100 : null,
      acquisitionEfficiency: newDonors > 0 ? 'effective' : 'needs_improvement'
    };
  }
}
```

### Data Table Implementation Context
**First-Time Donors Table Structure:**
```typescript
interface AcquisitionTableRow {
  date: string;
  newDonorCount: number;
  totalAmount: number;
  averageFirstGift: number;
  oneTimeCount: number;
  recurringCount: number;
  trendIndicator?: 'spike' | 'dip' | 'normal';
  comparisonNewDonorCount?: number;
  acquisitionChange?: number;
  acquisitionChangePercentage?: number;
}

const AcquisitionTableColumns = [
  {
    key: 'date',
    label: 'Date',
    sortable: true,
    formatter: (value: string) => format(new Date(value), 'MMM dd, yyyy')
  },
  {
    key: 'newDonorCount',
    label: 'New Donors',
    sortable: true,
    formatter: (value: number) => value.toLocaleString(),
    cellClassName: (row: AcquisitionTableRow) =>
      row.trendIndicator === 'spike' ? 'text-green-600 font-semibold' : ''
  },
  {
    key: 'totalAmount',
    label: 'Total Amount',
    sortable: true,
    formatter: (value: number) => `$${value.toLocaleString()}`
  },
  {
    key: 'averageFirstGift',
    label: 'Avg. First Gift',
    sortable: true,
    formatter: (value: number) => `$${value.toFixed(2)}`
  },
  {
    key: 'oneTimeCount',
    label: 'One-Time',
    sortable: true
  },
  {
    key: 'recurringCount',
    label: 'Recurring',
    sortable: true
  }
];
```

### Export Functionality Context
**Acquisition Export Options:**
```typescript
const handleExportAcquisitionCSV = () => {
  const csvData = timeSeriesData.map(row => ({
    'Date': format(new Date(row.date), 'yyyy-MM-dd'),
    'New Donors': row.newDonorCount,
    'Total Acquisition Amount': row.totalAmount,
    'Average First Gift': row.averageFirstGift,
    'One-Time New Donors': row.oneTimeCount,
    'Recurring New Donors': row.recurringCount,
    'Trend Indicator': row.trendIndicator || 'normal',
    ...(comparisonData && {
      'Comparison New Donors': row.comparisonNewDonorCount || '',
      'Acquisition Change %': row.acquisitionChangePercentage || ''
    })
  }));

  downloadCSV(csvData, 'first-time-donor-acquisition-analytics.csv');
};
```

### File Locations and Naming Conventions
**Chart Component Files:**
- `apps/web/components/charts/FirstTimeDonorsChart.tsx` - Main acquisition chart
- `apps/web/components/charts/AcquisitionTooltip.tsx` - Custom tooltip component
- `apps/web/components/tables/FirstTimeDonorsTable.tsx` - Acquisition data table

**API Route Files:**
- `apps/web/app/api/v1/analytics/first-time-donors/route.ts` - Acquisition analytics endpoint

**Calculation and Utility Files:**
- `apps/web/lib/calculations/firstTimeDonorCalculations.ts` - Acquisition analysis utilities
- `apps/web/hooks/useFirstTimeDonorsData.ts` - Data fetching hook
- `packages/shared/types/firstTimeDonors.ts` - TypeScript interfaces

### Performance Optimization Context
**Acquisition Query Optimization:**
```typescript
// Efficient first-time donor data fetching with historical lookback caching
const useFirstTimeDonorsData = (filters: FilterState) => {
  return useQuery({
    queryKey: ['first-time-donors', filters],
    queryFn: async () => {
      const params = new URLSearchParams({
        startDate: filters.dateRange.startDate.toISOString(),
        endDate: filters.dateRange.endDate.toISOString(),
        lookbackYears: '2', // For accurate first-time identification
        ...(filters.selectedAppeal && { appealId: filters.selectedAppeal.id }),
        ...(filters.frequency !== 'all' && { frequency: filters.frequency })
      });

      const response = await fetch(`/api/v1/analytics/first-time-donors?${params}`);
      return response.json();
    },
    staleTime: 8 * 60 * 1000, // 8 minutes cache (first-time calculations are expensive)
    refetchOnWindowFocus: false,
  });
};
```

## Testing

### Testing Standards [Source: docs/architecture.md#technology-stack-table]
**Testing Framework:** Jest + React Testing Library for component testing
**Test File Location:** `__tests__/` directories alongside acquisition components
**Testing Patterns:**
- Component rendering tests for acquisition chart and table components
- First-time donor identification logic tests with various donor scenarios
- Spike detection algorithm tests with historical data patterns
- Filter integration tests ensuring proper acquisition analysis

**Specific Testing Requirements for This Story:**
- First-time donor chart rendering with acquisition trend visualization
- New donor identification accuracy preventing duplicate counting
- Acquisition spike detection and visual indicator functionality
- Data table rendering with acquisition metrics and trend indicators
- Appeals and frequency filter integration for campaign-specific analysis
- Export functionality for acquisition reporting and analysis
- Performance testing for complex historical donor lookback queries

**Test Files to Create:**
- `apps/web/components/charts/__tests__/FirstTimeDonorsChart.test.tsx` - Chart component tests
- `apps/web/components/tables/__tests__/FirstTimeDonorsTable.test.tsx` - Table component tests
- `apps/web/lib/calculations/__tests__/firstTimeDonorCalculations.test.ts` - Calculation logic tests
- `apps/web/hooks/__tests__/useFirstTimeDonorsData.test.ts` - Data fetching hook tests
- `apps/web/__tests__/api/first-time-donors.test.ts` - API endpoint tests

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|---------|
| 2025-09-26 | 1.0 | Initial story creation with comprehensive first-time donor acquisition analytics implementation | Claude (Story Agent) |

## Dev Agent Record

*This section will be populated by the development agent during implementation*

### Agent Model Used
*To be filled by dev agent*

### Debug Log References
*To be filled by dev agent*

### Completion Notes List
*To be filled by dev agent*

### File List
*To be filled by dev agent*

## QA Results

*Results from QA Agent review will be populated here*