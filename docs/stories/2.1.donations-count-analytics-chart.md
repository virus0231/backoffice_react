# Story 2.1: Donations Count Analytics Chart

## Status
Draft

## Story

**As a** fundraising coordinator,
**I want** a time-series chart showing daily donation count trends in the Performance section of the sidebar dashboard,
**so that** I can track donation volume patterns and identify peak giving periods within the comprehensive analytics interface.

## Acceptance Criteria

1. Recharts line chart displaying donation count over selected time period
2. Comparison period overlay with percentage change indicators (green/red)
3. Responsive chart scaling with appropriate Y-axis ranges
4. Hover tooltips showing exact counts and dates
5. Associated data table below chart with sortable columns showing detailed breakdown
6. Integration with universal filter system (date, appeals, funds, frequency)
7. Export functionality for chart visualization and underlying data

## Tasks / Subtasks

- [ ] Create DonationsCountChart component (AC: 1)
  - [ ] Build DonationsCountChart component in `apps/web/components/charts/DonationsCountChart.tsx`
  - [ ] Implement Recharts LineChart with donation count time-series data
  - [ ] Configure chart dimensions and responsive container for optimal viewing
  - [ ] Add proper X-axis (date) and Y-axis (count) formatting
  - [ ] Style chart matching FundraisUP design with blue color scheme
  - [ ] Create chart loading skeleton and error states
- [ ] Implement comparison period overlay (AC: 2)
  - [ ] Integrate comparison system from Story 1.4 with chart component
  - [ ] Add secondary line for comparison period data with distinct styling
  - [ ] Implement percentage change calculation for donation count metrics
  - [ ] Create visual indicators showing growth/decline with green/red color coding
  - [ ] Add comparison legend distinguishing current vs. comparison periods
  - [ ] Include comparison period date range display
- [ ] Configure responsive chart behavior (AC: 3)
  - [ ] Implement responsive Y-axis scaling based on data ranges
  - [ ] Add automatic tick interval calculation for optimal readability
  - [ ] Configure chart margins and padding for different screen sizes
  - [ ] Ensure chart maintains readability on mobile devices
  - [ ] Add responsive font sizing for axis labels and tooltips
  - [ ] Test chart rendering across desktop, tablet, and mobile viewports
- [ ] Create interactive tooltips and hover states (AC: 4)
  - [ ] Build custom Recharts tooltip showing exact donation counts
  - [ ] Add date formatting in tooltips with readable date display
  - [ ] Include comparison data in tooltip when overlay is active
  - [ ] Style tooltips matching FundraisUP design specifications
  - [ ] Add hover effects for chart lines with proper visual feedback
  - [ ] Ensure tooltip positioning works correctly on all screen sizes
- [ ] Build donations count data table (AC: 5)
  - [ ] Create DonationsCountTable component in `apps/web/components/tables/DonationsCountTable.tsx`
  - [ ] Implement sortable columns: Date, Donation Count, Amount Total, Average Gift
  - [ ] Add pagination for large datasets with configurable page sizes
  - [ ] Include comparison period data in table when overlay is active
  - [ ] Style table matching FundraisUP data table specifications
  - [ ] Add table loading states and empty state handling
- [ ] Integrate universal filter system (AC: 6)
  - [ ] Connect chart to global filter state from Story 1.3
  - [ ] Implement date range filtering affecting donation count queries
  - [ ] Add appeals/campaigns filtering to donation count calculations
  - [ ] Include funds filtering for donation count analytics
  - [ ] Integrate frequency filtering (one-time, recurring, first installments)
  - [ ] Ensure real-time chart updates when filters change
- [ ] Create export functionality (AC: 7)
  - [ ] Build export button component for chart and data export
  - [ ] Implement CSV export for donation count data with filtered results
  - [ ] Add chart image export functionality (PNG/SVG)
  - [ ] Include comparison period data in export when active
  - [ ] Create formatted export with proper headers and metadata
  - [ ] Add export loading states and success/error notifications

## Dev Notes

### Previous Story Insights
**Story Dependencies:** This story builds on the database foundation (Story 1.2), universal filter system (Story 1.3), comparison system (Story 1.4), and follows the pattern established by the primary revenue dashboard (Story 1.5).

### Technical Architecture Context
**Donations Count Requirements:** [Source: docs/prd.md#functional-requirements]
- Donations Count analytics with time-series chart showing donation count trends (FR10)
- Comparison overlay functionality showing donation volume changes between periods
- Integration with universal filter system for appeals, funds, and frequency filtering
- Data export capabilities including comparison data

**Operational Analytics Context:** [Source: docs/prd.md#epic-2-operational-analytics-charts]
- Essential operational analytics for daily fundraising management
- Donation count tracking for identifying peak giving periods
- Integration with comprehensive dashboard providing operational insights

**Chart Component Pattern:** [Source: docs/architecture.md#chart-component-pattern]
```typescript
interface DonationsCountChartProps {
  initialData: DonationCountData;
  comparisonData?: DonationCountData;
  isLoading?: boolean;
  error?: Error | null;
}

// Usage pattern
<DonationsCountChart
  initialData={donationCountData}
  comparisonData={comparisonEnabled ? comparisonData : undefined}
/>
```

### Database Query Logic Context
**Donations Count Query Structure:** [Source: docs/architecture.md#calculated-fields-and-query-helpers]
```sql
-- Daily donation counts with filtering support
SELECT
  DATE(donation_date) as date,
  COUNT(*) as donation_count,
  SUM(amount) as total_amount,
  AVG(amount) as average_amount
FROM pw_transactions
WHERE status = 'completed'
  AND donation_date BETWEEN ? AND ?
  AND (appeal_id = ? OR ? IS NULL)
  AND (fundlist_id = ? OR ? IS NULL)
  AND (
    (? = 'all') OR
    (? = 'one-time' AND freq = 0) OR
    (? = 'recurring' AND freq > 0) OR
    (? = 'first-installments' AND freq = 1 AND order_id NOT REGEXP '_') OR
    (? = 'next-installments' AND (freq > 1 OR (freq = 1 AND order_id REGEXP '_')))
  )
GROUP BY DATE(donation_date)
ORDER BY date;
```

**Query Collaboration Workflow:** [Source: docs/prd.md#query-collaboration-process]
1. Development agent requests donation count query with time grouping and filtering
2. User provides base SQL working with pw_transactions table
3. Agent optimizes query for Sequelize with universal filtering integration
4. Validation cycle ensuring accurate count calculations and performance

### API Integration Context
**Donations Count API Endpoint:**
- `GET /api/v1/analytics/donations-count` - Primary endpoint for donation count data

**API Response Structure:**
```typescript
interface DonationsCountResponse {
  data: {
    currentPeriod: {
      totalCount: number;
      totalAmount: number;
      averageAmount: number;
      peakDay: {
        date: string;
        count: number;
      };
    };
    comparisonPeriod?: {
      totalCount: number;
      totalAmount: number;
      averageAmount: number;
      peakDay: {
        date: string;
        count: number;
      };
    };
    timeSeriesData: Array<{
      date: string;
      count: number;
      amount: number;
      average: number;
    }>;
    comparisonTimeSeriesData?: Array<{
      date: string;
      count: number;
      amount: number;
      average: number;
    }>;
    growth?: {
      countChange: number;
      countPercentage: number;
      amountChange: number;
      amountPercentage: number;
      direction: 'up' | 'down';
    };
  };
  meta: {
    granularity: 'daily' | 'weekly';
    cached: boolean;
    lastUpdated: string;
  };
}
```

### Recharts Implementation Context
**Line Chart Configuration:**
```typescript
// Donations count line chart setup
<ResponsiveContainer width="100%" height={400}>
  <LineChart data={timeSeriesData} margin={{ top: 20, right: 30, left: 20, bottom: 20 }}>
    <CartesianGrid strokeDasharray="3 3" />
    <XAxis
      dataKey="date"
      tickFormatter={(date) => format(new Date(date), 'MMM dd')}
    />
    <YAxis
      tickFormatter={(value) => value.toLocaleString()}
      domain={['dataMin - 10', 'dataMax + 10']}
    />
    <Tooltip
      formatter={(value, name) => [value.toLocaleString(), name]}
      labelFormatter={(date) => format(new Date(date), 'MMM dd, yyyy')}
    />
    <Legend />
    <Line
      type="monotone"
      dataKey="count"
      stroke="#3b82f6"
      strokeWidth={2}
      name="Current Period"
      dot={{ r: 4 }}
    />
    {comparisonData && (
      <Line
        type="monotone"
        dataKey="comparisonCount"
        stroke="#94a3b8"
        strokeWidth={2}
        strokeDasharray="5 5"
        name="Comparison Period"
        dot={{ r: 4 }}
      />
    )}
  </LineChart>
</ResponsiveContainer>
```

### Data Table Implementation Context
**Donations Count Table Columns:**
```typescript
interface DonationsCountTableRow {
  date: string;
  donationCount: number;
  totalAmount: number;
  averageAmount: number;
  comparisonCount?: number;
  comparisonAmount?: number;
  countChange?: number;
  countChangePercentage?: number;
}

const tableColumns = [
  { key: 'date', label: 'Date', sortable: true },
  { key: 'donationCount', label: 'Donations', sortable: true },
  { key: 'totalAmount', label: 'Total Amount', sortable: true, format: 'currency' },
  { key: 'averageAmount', label: 'Avg. Gift', sortable: true, format: 'currency' },
  { key: 'countChange', label: 'Change', sortable: true, format: 'percentage', conditional: true }
];
```

### Performance Optimization Context
**Chart Performance Requirements:** [Source: docs/prd.md#non-functional-requirements]
- Dashboard load times under 3 seconds for all visualizations
- Support concurrent usage without performance degradation
- Efficient data fetching preventing redundant database queries

**Optimization Strategies:**
```typescript
// Data fetching with caching and debouncing
const useDonationsCountData = (filters: FilterState) => {
  return useQuery({
    queryKey: ['donations-count', filters],
    queryFn: () => fetchDonationsCountData(filters),
    staleTime: 5 * 60 * 1000, // 5 minutes cache
    refetchOnWindowFocus: false,
  });
};

// Debounced filter updates
const debouncedFilters = useDebouncedValue(filters, 300);
```

### Export Functionality Context
**Export Options:**
- CSV export with donation count time-series data
- Chart image export (PNG format)
- Formatted reports including comparison data when active
- Export respecting current filter selections

**Export Implementation:**
```typescript
const handleExportCSV = () => {
  const csvData = timeSeriesData.map(row => ({
    'Date': format(new Date(row.date), 'yyyy-MM-dd'),
    'Donation Count': row.count,
    'Total Amount': row.amount,
    'Average Amount': row.average,
    ...(comparisonData && {
      'Comparison Count': row.comparisonCount || '',
      'Count Change %': row.countChangePercentage || ''
    })
  }));

  downloadCSV(csvData, 'donations-count-analytics.csv');
};
```

### File Locations and Naming Conventions
**Chart Component Files:**
- `apps/web/components/charts/DonationsCountChart.tsx` - Main chart component
- `apps/web/components/charts/configs/donationsCountChartConfig.ts` - Chart configuration
- `apps/web/components/tables/DonationsCountTable.tsx` - Data table component

**API Route Files:**
- `apps/web/app/api/v1/analytics/donations-count/route.ts` - Donations count endpoint

**Hook and Utility Files:**
- `apps/web/hooks/useDonationsCountData.ts` - Data fetching hook
- `apps/web/lib/calculations/donationsCountCalculations.ts` - Count calculation utilities
- `apps/web/lib/export/donationsCountExport.ts` - Export functionality

**Type Definition Files:**
- `packages/shared/types/donationsCount.ts` - TypeScript interfaces
- `packages/shared/types/analytics.ts` - Shared analytics types

### Integration with Universal Filter System
**Filter Integration Pattern:**
```typescript
// Integration with global filter state
const DonationsCountChart = ({ initialData }: DonationsCountChartProps) => {
  const { dateRange, selectedAppeal, selectedFund, frequency } = useFilterStore();
  const comparison = useComparisonStore(state =>
    state.getChartComparison('donations-count')
  );

  const { data, isLoading, error } = useDonationsCountData({
    startDate: dateRange.startDate,
    endDate: dateRange.endDate,
    appealId: selectedAppeal?.id,
    fundId: selectedFund?.id,
    frequency: frequency,
    compareStartDate: comparison?.startDate,
    compareEndDate: comparison?.endDate
  });

  // Chart rendering logic...
};
```

### Responsive Design Implementation
**Mobile-First Responsive Strategy:**
```typescript
// Responsive chart configuration
const getChartHeight = () => {
  if (typeof window === 'undefined') return 400;
  return window.innerWidth < 768 ? 300 : 400; // Shorter on mobile
};

// Responsive table with horizontal scroll
<div className="overflow-x-auto">
  <table className="min-w-full divide-y divide-gray-200">
    {/* Table content */}
  </table>
</div>
```

## Testing

### Testing Standards [Source: docs/architecture.md#technology-stack-table]
**Testing Framework:** Jest + React Testing Library for component testing
**Test File Location:** `__tests__/` directories alongside chart components
**Testing Patterns:**
- Component rendering tests for chart and table components
- Data fetching hook tests with mock API responses
- Filter integration tests ensuring proper data updates
- Export functionality tests validating CSV and image generation

**Specific Testing Requirements for This Story:**
- Donations count chart rendering with time-series data
- Comparison period overlay functionality and percentage calculations
- Responsive chart behavior across different viewport sizes
- Interactive tooltip display and formatting
- Data table rendering with sortable columns and pagination
- Universal filter integration with real-time updates
- Export functionality for CSV and chart image formats
- Performance testing ensuring sub-3-second load times

**Test Files to Create:**
- `apps/web/components/charts/__tests__/DonationsCountChart.test.tsx` - Chart component tests
- `apps/web/components/tables/__tests__/DonationsCountTable.test.tsx` - Table component tests
- `apps/web/hooks/__tests__/useDonationsCountData.test.ts` - Data fetching hook tests
- `apps/web/__tests__/api/donations-count.test.ts` - API endpoint tests
- `apps/web/lib/export/__tests__/donationsCountExport.test.ts` - Export functionality tests

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|---------|
| 2025-09-26 | 1.0 | Initial story creation with comprehensive donations count analytics implementation | Claude (Story Agent) |

## Dev Agent Record

*This section will be populated by the development agent during implementation*

### Agent Model Used
*To be filled by dev agent*

### Debug Log References
*To be filled by dev agent*

### Completion Notes List
*To be filled by dev agent*

### File List
*To be filled by dev agent*

## QA Results

*Results from QA Agent review will be populated here*